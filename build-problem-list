#!/usr/bin/env bash
set -euo pipefail

OUTFILE="problems.js"
TMPFILE="$(mktemp).js"

write() { echo "$@" >> "$TMPFILE"; }

load-problem-name() {
  jq -r .meta.name "$1/problem.json"
}

is-problem-enabled() {
  if [[ -f enabled-problems ]]; then
    grep -qx "$1" enabled-problems
  else
    return 0
  fi
}

# header
write "// THIS FILE IS AUTOGENERATED. DO NOT EDIT MANUALLY."
write ""

find . -mindepth 2 -maxdepth 2 -type f -name problem.json -printf '%h\n' \
  | sed 's|^\./||' \
  | sort \
  | while IFS= read -r dir; do
      name=$(load-problem-name "$dir")
      if is-problem-enabled "$name"; then
        write "import $name from './$dir/problem.json';"
      fi
    done

write ""
write "const problems = ["

find . -mindepth 2 -maxdepth 2 -type f -name problem.json -printf '%h\n' \
  | sed 's|^\./||' \
  | sort \
  | while IFS= read -r dir; do
      name=$(load-problem-name "$dir")
      if is-problem-enabled "$name"; then
        write "  $name,"
      fi
    done

write "];"
write ""
write "export default problems;"

mv "$TMPFILE" "$OUTFILE"
echo "Build succeeded: $OUTFILE"
